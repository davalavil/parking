<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Parkings en Alquiler (Local)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            width: 100%;
            height: 300px;
        }
        body {
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7fafc; /* Un gris muy claro por defecto */
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        /* Estilos para añadir animación y mejorar la visualización */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilo para mensajes de alerta */
        .alert {
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 6px;
            transition: all 0.4s ease;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }
        .alert-success {
            background-color: #e6fffa;
            color: #38a169;
            border-color: #9ae6b4;
        }
        .alert-danger {
            background-color: #fff5f5;
            color: #e53e3e;
            border-color: #feb2b2;
        }
        .alert-warning {
            background-color: #fffaf0;
            color: #dd6b20;
            border-color: #fbd38d;
        }
        .alert-info {
             background-color: #ebf8ff;
             color: #3182ce;
             border-color: #90cdf4;
        }
        /* Estilo para animación en hover de botones */
        .btn-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }
        /* Estilos para tablas */
        .table-hover tbody tr:hover {
            background-color: #edf2f7; /* Gris más claro para hover */
        }
        .grid-cols-stats {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
         /* Estilos básicos para Modo Oscuro (si se activa) */
        body.dark {
            background-color: #1a202c;
            color: #cbd5e0;
        }
        body.dark .bg-white { background-color: #2d3748; }
        body.dark .bg-gray-100 { background-color: #2d3748; }
        body.dark .bg-gray-50 { background-color: #4a5568; }
        body.dark .text-gray-800 { color: #e2e8f0; }
        body.dark .text-gray-700 { color: #a0aec0; }
        body.dark .text-gray-600 { color: #a0aec0; }
        body.dark .text-gray-500 { color: #718096; }
        body.dark .border-b { border-color: #4a5568; }
        body.dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2); }
        body.dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2); }
        body.dark .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2); }
        body.dark .table-hover tbody tr:hover { background-color: #4a5568; }
        body.dark select, body.dark input[type="text"], body.dark input[type="number"], body.dark input[type="date"], body.dark input[type="email"], body.dark input[type="tel"], body.dark textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #e2e8f0;
        }
        body.dark .bg-blue-100 { background-color: #2c5282; } /* Ajustar colores de estado activo de pestaña */
        body.dark .text-blue-600 { color: #63b3ed; }
        body.dark .text-blue-800 { color: #90cdf4; }
        body.dark .text-green-600 { color: #68d391; }
        body.dark .text-red-600 { color: #fc8181; }
        body.dark .text-blue-700 { color: #63b3ed; }
        body.dark .text-red-700 { color: #fc8181; }
        /* ... (añadir más estilos dark si es necesario) ... */
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold flex items-center">
                <i class="fas fa-parking mr-2"></i>
                Gestión Parkings (Local)
            </h1>
            <div class="flex space-x-2 items-center">
                <button id="darkModeToggle" class="p-2 rounded hover:bg-blue-700 transition" aria-label="Cambiar modo oscuro" title="Modo Oscuro">
                    <i class="fas fa-moon"></i>
                </button>
                <!-- Input oculto para seleccionar archivo -->
                <input type="file" id="loadDataInput" accept=".json" style="display: none;">
                <!-- Botón visible para cargar -->
                <button id="loadDataBtn" title="Cargar datos desde archivo JSON" class="p-2 rounded bg-green-500 hover:bg-green-600 transition text-sm font-medium flex items-center btn-animated">
                    <i class="fas fa-folder-open mr-1"></i> <span class="hidden sm:inline">Cargar</span>
                </button>
                <!-- Botón para guardar (descargar archivo) -->
                <button id="saveDataToFileBtn" title="Guardar cambios en archivo JSON" class="p-2 rounded bg-blue-700 hover:bg-blue-800 transition text-sm font-medium flex items-center btn-animated">
                    <i class="fas fa-save mr-1"></i> <span class="hidden sm:inline">Guardar</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Tabs Navigation -->
    <div class="container mx-auto mt-4 px-4 md:px-0">
        <div class="bg-white shadow-md rounded-t-lg">
            <ul class="flex border-b overflow-x-auto">
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="dashboard">
                    <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                        <i class="fas fa-home mr-1 md:mr-2"></i><span class="hidden md:inline">Dashboard</span><span class="md:hidden">Dash</span>
                    </a>
                </li>
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="parkings">
                    <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                        <i class="fas fa-car mr-1 md:mr-2"></i>Parkings
                    </a>
                </li>
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="tenants">
                    <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                        <i class="fas fa-users mr-1 md:mr-2"></i>Inquilinos
                    </a>
                </li>
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="finances">
                    <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                        <i class="fas fa-euro-sign mr-1 md:mr-2"></i>Finanzas
                    </a>
                </li>
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="forecast">
                    <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                        <i class="fas fa-chart-line mr-1 md:mr-2"></i><span class="hidden md:inline">Previsiones</span><span class="md:hidden">Prev</span>
                    </a>
                </li>
                <li class="tab-btn mr-1 flex-shrink-0" data-tab="compound">
                     <a class="bg-white inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-semibold whitespace-nowrap" href="#">
                         <i class="fas fa-chart-pie mr-1 md:mr-2"></i><span class="hidden md:inline">Proy. Compuesta</span><span class="md:hidden">Comp</span>
                     </a>
                 </li>
            </ul>
        </div>

        <!-- Tab Contents -->
        <div class="bg-white shadow-md rounded-b-lg p-4 md:p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active fade-in">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Dashboard</h2>
                <p id="dashboard-message" class="text-gray-600 mb-4">Carga un archivo de datos (`.json`) para empezar.</p>

                <div class="grid grid-cols-1 md:grid-cols-stats gap-6 mb-6">
                    <!-- Estadísticas generales -->
                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500 card">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-500 mr-4">
                                <i class="fas fa-car text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Total Parkings</p>
                                <p class="text-2xl font-bold" id="totalParkings">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500 card">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-500 mr-4">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Parkings Ocupados</p>
                                <p class="text-2xl font-bold" id="occupiedParkings">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500 card">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500 mr-4">
                                <i class="fas fa-euro-sign text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Ingresos Mensuales (Est.)</p>
                                <p class="text-2xl font-bold" id="monthlyIncome">0 €</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500 card">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-500 mr-4">
                                <i class="fas fa-minus-circle text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Gastos Mes Actual</p>
                                <p class="text-2xl font-bold" id="monthlyExpenses">0 €</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Parkings recientes -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Parkings Recientes</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white table-hover">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">Ubicación</th>
                                        <th class="py-2 px-4 border-b text-left">Estado</th>
                                        <th class="py-2 px-4 border-b text-right">Alquiler</th>
                                    </tr>
                                </thead>
                                <tbody id="recentParkingsTable">
                                    <tr>
                                        <td colspan="3" class="py-4 px-4 text-center text-gray-500">Carga datos para ver parkings</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Acciones rápidas -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Acciones Rápidas</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button id="quickAddParking" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded flex items-center justify-center btn-animated transition">
                                <i class="fas fa-plus-circle mr-2"></i> Añadir Parking
                            </button>
                            <button id="quickAddTenant" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded flex items-center justify-center btn-animated transition">
                                <i class="fas fa-user-plus mr-2"></i> Añadir Inquilino
                            </button>
                            <button id="quickAddExpense" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded flex items-center justify-center btn-animated transition">
                                <i class="fas fa-minus-circle mr-2"></i> Registrar Gasto
                            </button>
                            <button id="quickAddIncome" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded flex items-center justify-center btn-animated transition">
                                <i class="fas fa-plus-circle mr-2"></i> Registrar Ingreso
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parkings Tab -->
            <div id="parkings" class="tab-content fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gestión de Parkings</h2>
                    <button id="addParkingBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                        <i class="fas fa-plus-circle mr-2"></i> Nuevo Parking
                    </button>
                </div>

                <!-- Filtros de búsqueda -->
                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="searchParking">
                                Buscar por ubicación:
                            </label>
                            <input id="searchParking" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ingrese ubicación...">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="filterParkingStatus">
                                Filtrar por estado:
                            </label>
                            <select id="filterParkingStatus" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="all">Todos</option>
                                <option value="occupied">Ocupados</option>
                                <option value="available">Disponibles</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sortParkings">
                                Ordenar por:
                            </label>
                            <select id="sortParkings" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="location">Ubicación (A-Z)</option>
                                <option value="price">Precio Alquiler (€)</option>
                                <option value="size">Tamaño (m²)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla de parkings -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full bg-white table-hover">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 border-b text-left">ID</th>
                                <th class="py-3 px-4 border-b text-left">Ubicación</th>
                                <th class="py-3 px-4 border-b text-right">Tamaño (m²)</th>
                                <th class="py-3 px-4 border-b text-left">Características</th>
                                <th class="py-3 px-4 border-b text-right">Alquiler (€/mes)</th>
                                <th class="py-3 px-4 border-b text-center">Estado</th>
                                <th class="py-3 px-4 border-b text-left">Inquilino</th>
                                <th class="py-3 px-4 border-b text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="parkingsTable">
                            <tr>
                                <td colspan="8" class="py-4 px-4 text-center text-gray-500">Carga datos o añade un parking para empezar.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tenants Tab -->
            <div id="tenants" class="tab-content fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gestión de Inquilinos</h2>
                    <button id="addTenantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                        <i class="fas fa-user-plus mr-2"></i> Nuevo Inquilino
                    </button>
                </div>

                <!-- Filtros de búsqueda -->
                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="searchTenant">
                                Buscar por nombre:
                            </label>
                            <input id="searchTenant" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ingrese nombre...">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sortTenants">
                                Ordenar por:
                            </label>
                            <select id="sortTenants" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="name">Nombre (A-Z)</option>
                                <option value="startDate">Fecha de inicio (Antigua primero)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla de inquilinos -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full bg-white table-hover">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 border-b text-left">ID</th>
                                <th class="py-3 px-4 border-b text-left">Nombre</th>
                                <th class="py-3 px-4 border-b text-left">Teléfono</th>
                                <th class="py-3 px-4 border-b text-left">Email</th>
                                <th class="py-3 px-4 border-b text-left">Parking Asignado</th>
                                <th class="py-3 px-4 border-b text-center">Inicio</th>
                                <th class="py-3 px-4 border-b text-center">Fin</th>
                                <th class="py-3 px-4 border-b text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsTable">
                            <tr>
                                <td colspan="8" class="py-4 px-4 text-center text-gray-500">Carga datos o añade un inquilino para empezar.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

             <!-- Finances Tab -->
            <div id="finances" class="tab-content fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gestión Financiera</h2>
                    <div class="flex space-x-2">
                        <button id="addExpenseBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                            <i class="fas fa-minus-circle mr-2"></i> Registrar Gasto
                        </button>
                        <button id="addIncomeBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                            <i class="fas fa-plus-circle mr-2"></i> Registrar Ingreso
                        </button>
                    </div>
                </div>

                <!-- Resumen financiero -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500 card">
                        <h3 class="text-gray-500 text-sm">Ingresos Totales</h3>
                        <p class="text-2xl font-bold" id="totalIncome">0 €</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500 card">
                        <h3 class="text-gray-500 text-sm">Gastos Totales</h3>
                        <p class="text-2xl font-bold" id="totalExpenses">0 €</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 card">
                        <h3 class="text-gray-500 text-sm">Balance Histórico</h3>
                        <p class="text-2xl font-bold" id="totalBalance">0 €</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500 card">
                        <h3 class="text-gray-500 text-sm">ROI (Últimos 12m)</h3>
                        <p class="text-2xl font-bold" id="annualROI">0%</p>
                    </div>
                </div>

                <!-- Filtros y período -->
                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="financesPeriod">
                                Período:
                            </label>
                            <select id="financesPeriod" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="all">Todo</option>
                                <option value="month">Último mes</option>
                                <option value="quarter">Último trimestre</option>
                                <option value="year">Último año</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="financesParkingFilter">
                                Filtrar por parking:
                            </label>
                            <select id="financesParkingFilter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="all">Todos los parkings</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="financeType">
                                Tipo:
                            </label>
                            <select id="financeType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="all">Todos</option>
                                <option value="income">Ingresos</option>
                                <option value="expense">Gastos</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla de movimientos financieros -->
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full bg-white table-hover">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 border-b text-center">Fecha</th>
                                <th class="py-3 px-4 border-b text-left">Tipo</th>
                                <th class="py-3 px-4 border-b text-left">Concepto</th>
                                <th class="py-3 px-4 border-b text-left">Parking</th>
                                <th class="py-3 px-4 border-b text-right">Importe</th>
                                <th class="py-3 px-4 border-b text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="financesTable">
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center text-gray-500">Carga datos o registra movimientos para empezar.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Forecast Tab -->
            <div id="forecast" class="tab-content fade-in">
                 <h2 class="text-2xl font-bold mb-6 text-gray-800">Previsiones Anuales (Simple)</h2>
                <!-- Parámetros de previsión -->
                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">Parámetros de Previsión</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="forecastIncrementRate">
                                Incremento anual de alquiler (%):
                            </label>
                            <input id="forecastIncrementRate" type="number" min="0" max="100" step="0.5" value="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="forecastExpenseRate">
                                Incremento anual de gastos (%):
                            </label>
                            <input id="forecastExpenseRate" type="number" min="0" max="100" step="0.5" value="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="forecastOccupancyRate">
                                Tasa de ocupación (%):
                            </label>
                            <input id="forecastOccupancyRate" type="number" min="0" max="100" step="1" value="90" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="calculateForecastBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                            <i class="fas fa-calculator mr-2"></i> Calcular Previsión Simple
                        </button>
                    </div>
                </div>

                <!-- Resultados de previsión -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">Previsión de Ingresos y Gastos - Próximos 5 años</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white table-hover">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 border-b text-left">Año</th>
                                    <th class="py-3 px-4 border-b text-right">Ingresos</th>
                                    <th class="py-3 px-4 border-b text-right">Gastos</th>
                                    <th class="py-3 px-4 border-b text-right">Balance</th>
                                    <th class="py-3 px-4 border-b text-right">ROI (sobre Inv. Actual)</th>
                                </tr>
                            </thead>
                            <tbody id="forecastTable">
                                <tr>
                                    <td colspan="5" class="py-4 px-4 text-center text-gray-500">Carga datos y calcule la previsión para ver los resultados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Gráfico de previsión -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Gráfico de Previsión Simple</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div> <!-- Cierre de forecast -->

            <!-- Compound Growth Forecast Tab -->
            <div id="compound" class="tab-content fade-in">
                 <h2 class="text-2xl font-bold mb-6 text-gray-800">Proyección de Crecimiento Compuesto</h2>

                 <!-- Parámetros de Proyección Compuesta -->
                 <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                     <h3 class="text-lg font-semibold mb-4">Parámetros de la Proyección</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div>
                             <label class="block text-gray-700 text-sm font-bold mb-2" for="compoundProfitGrowthRate">
                                 Crecimiento Anual del Beneficio Neto (%):
                             </label>
                             <input id="compoundProfitGrowthRate" type="number" min="0" max="100" step="0.5" value="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" title="Estimación de cuánto crece el beneficio neto cada año (puede ser diferente al crecimiento de ingresos o gastos).">
                         </div>
                          <div>
                              <p class="text-gray-700 text-sm font-bold mb-2">Capital Invertido Inicial:</p>
                              <p id="compoundInitialInvestment" class="text-lg font-semibold">0 €</p>
                          </div>
                          <div>
                              <p class="text-gray-700 text-sm font-bold mb-2">Balance Acumulado Inicial:</p>
                              <p id="compoundInitialBalance" class="text-lg font-semibold">0 €</p>
                          </div>
                          <div>
                              <p class="text-gray-700 text-sm font-bold mb-2">Beneficio Neto Anual Base (Estimado):</p>
                              <p id="compoundBaseAnnualProfit" class="text-lg font-semibold">0 €</p>
                          </div>
                     </div>

                     <h3 class="text-lg font-semibold mb-4 mt-6">Inversiones Futuras Planificadas</h3>
                     <div id="futureInvestmentsContainer" class="space-y-2 mb-4">
                         <!-- Filas de inversión se añadirán aquí dinámicamente o pre-rellenadas por JS -->
                         <div class="flex items-center space-x-2 future-investment-row">
                             <input type="number" min="2025" placeholder="Año" class="shadow appearance-none border rounded w-1/3 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline future-investment-year">
                             <input type="number" min="0" step="100" placeholder="Coste (€)" class="shadow appearance-none border rounded w-1/3 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline future-investment-cost">
                             <button type="button" class="text-red-500 hover:text-red-700 remove-investment-btn" title="Eliminar Inversión">
                                 <i class="fas fa-trash-alt"></i>
                             </button>
                         </div>
                     </div>
                     <button id="addInvestmentRowBtn" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm font-bold py-1 px-3 rounded btn-animated transition">
                         <i class="fas fa-plus mr-1"></i> Añadir Inversión Futura
                     </button>

                     <div class="mt-6">
                         <button id="calculateCompoundForecastBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded btn-animated transition">
                             <i class="fas fa-calculator mr-2"></i> Calcular Proyección Compuesta
                         </button>
                     </div>
                 </div>

                 <!-- Resultados de Proyección Compuesta -->
                 <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-semibold mb-4">Proyección Acumulada - Próximos 5 años</h3>
                     <p class="text-sm text-gray-600 mb-4">Muestra la ganancia neta total acumulada al final de cada año, después de considerar beneficios e inversiones.</p>
                     <div class="overflow-x-auto">
                         <table class="min-w-full bg-white table-hover">
                             <thead class="bg-gray-100">
                                 <tr>
                                     <th class="py-3 px-4 border-b text-left">Año</th>
                                     <th class="py-3 px-4 border-b text-right">Capital Invertido (Total Fin Año)</th>
                                     <th class="py-3 px-4 border-b text-right">Beneficio Generado (Este Año)</th>
                                     <th class="py-3 px-4 border-b text-right">Inversión Realizada (Este Año)</th>
                                     <th class="py-3 px-4 border-b text-right">Ganancia Neta Acumulada (Fin Año)</th>
                                 </tr>
                             </thead>
                             <tbody id="compoundForecastTable">
                                 <tr>
                                     <td colspan="5" class="py-4 px-4 text-center text-gray-500">Calcule la proyección para ver los resultados</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>
            </div> <!-- Cierre de compound -->

        </div> <!-- Cierre del contenedor principal de pestañas -->
    </div> <!-- Cierre del container -->

    <!-- MODALES (Sin cambios aquí) -->
    <!-- Modal para añadir/editar parking -->
    <div id="parkingModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center modal p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="parkingModalTitle">Añadir Nuevo Parking</h3>
                <button class="text-gray-500 hover:text-gray-700" id="closeParkingModal" aria-label="Cerrar modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="parkingForm">
                <input type="hidden" id="parkingId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingLocation">
                        Ubicación: <span class="text-red-500">*</span>
                    </label>
                    <input id="parkingLocation" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Dirección completa del parking">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingSize">
                            Tamaño (m²): <span class="text-red-500">*</span>
                        </label>
                        <input id="parkingSize" type="number" min="1" step="0.1" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 12.5">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingPrice">
                            Precio Alquiler (€/mes): <span class="text-red-500">*</span>
                        </label>
                        <input id="parkingPrice" type="number" min="0" step="0.01" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 75.00">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingFeatures">
                        Características:
                    </label>
                    <textarea id="parkingFeatures" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Ej: Plaza cubierta, mando a distancia, vigilancia 24h..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingPurchasePrice">
                        Precio de Compra (€) (Para ROI):
                    </label>
                    <input id="parkingPurchasePrice" type="number" min="0" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Precio de adquisición">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="parkingPurchaseDate">
                        Fecha de Compra (Para ROI):
                    </label>
                    <input id="parkingPurchaseDate" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end pt-4 border-t mt-4">
                    <button type="button" id="cancelParkingBtn" class="mr-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded btn-animated transition">
                        Cancelar
                    </button>
                    <button type="submit" id="saveParkingBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                        <i class="fas fa-save mr-2"></i>Guardar Parking
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para añadir/editar inquilino -->
    <div id="tenantModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center modal p-4 z-50">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl max-h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-4 pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="tenantModalTitle">Añadir Nuevo Inquilino</h3>
                 <button class="text-gray-500 hover:text-gray-700" id="closeTenantModal" aria-label="Cerrar modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="tenantForm">
                <input type="hidden" id="tenantId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantName">
                        Nombre completo: <span class="text-red-500">*</span>
                    </label>
                    <input id="tenantName" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre y apellidos">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantPhone">
                            Teléfono: <span class="text-red-500">*</span>
                        </label>
                        <input id="tenantPhone" type="tel" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Número de teléfono">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantEmail">
                            Email:
                        </label>
                        <input id="tenantEmail" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Correo electrónico">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantParking">
                        Parking Asignado: <span class="text-red-500">*</span>
                    </label>
                    <select id="tenantParking" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccione un parking disponible...</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantStartDate">
                            Fecha de Inicio: <span class="text-red-500">*</span>
                        </label>
                        <input id="tenantStartDate" type="date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantEndDate">
                            Fecha de Fin (opcional):
                        </label>
                        <input id="tenantEndDate" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="tenantNotes">
                        Notas:
                    </label>
                    <textarea id="tenantNotes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Información adicional: Matrícula, modelo coche, etc."></textarea>
                </div>
                <div class="flex justify-end pt-4 border-t mt-4">
                     <button type="button" id="cancelTenantBtn" class="mr-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded btn-animated transition">
                        Cancelar
                    </button>
                    <button type="submit" id="saveTenantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                         <i class="fas fa-save mr-2"></i>Guardar Inquilino
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para añadir transacción financiera -->
    <div id="financeModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center modal p-4 z-50">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl max-h-full overflow-y-auto">
             <div class="flex justify-between items-center mb-4 pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="financeModalTitle">Registrar Ingreso</h3>
                 <button class="text-gray-500 hover:text-gray-700" id="closeFinanceModal" aria-label="Cerrar modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="financeForm">
                <input type="hidden" id="financeId">
                <input type="hidden" id="financeTransactionType" value="income">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="financeDate">
                        Fecha: <span class="text-red-500">*</span>
                    </label>
                    <input id="financeDate" type="date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="financeConcept">
                        Concepto: <span class="text-red-500">*</span>
                    </label>
                    <input id="financeConcept" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Breve descripción">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="financeParking">
                        Parking relacionado (opcional):
                    </label>
                    <select id="financeParking" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Ninguno (general)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="financeAmount">
                        Importe (€): <span class="text-red-500">*</span>
                    </label>
                    <input id="financeAmount" type="number" min="0.01" step="0.01" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 75.00">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="financeNotes">
                        Notas adicionales:
                    </label>
                    <textarea id="financeNotes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Detalles: nº factura, método pago..."></textarea>
                </div>
                 <div class="flex justify-end pt-4 border-t mt-4">
                     <button type="button" id="cancelFinanceBtn" class="mr-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded btn-animated transition">
                        Cancelar
                    </button>
                    <!-- El color de este botón se ajusta dinámicamente en JS -->
                    <button type="submit" id="saveFinanceBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded btn-animated transition">
                        <i class="fas fa-save mr-2"></i>Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Panel de notificaciones -->
    <div id="notifications" class="fixed bottom-5 right-5 w-full max-w-sm z-50 space-y-2">
        <!-- Las notificaciones se añadirán aquí dinámicamente -->
    </div>

    <!-- Script para Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <script>
        // Modelo de datos (en memoria)
        let parkings = [];
        let tenants = [];
        let finances = [];

        // --- Inicio: Funciones para Cargar/Guardar Archivo Local ---

        // Función para manejar la selección de archivo y cargar los datos
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                showNotification('No se seleccionó ningún archivo.', 'warning');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const loadedData = JSON.parse(content);

                    // Validar que el JSON tiene la estructura esperada
                    if (loadedData && typeof loadedData === 'object' &&
                        Array.isArray(loadedData.parkings) &&
                        Array.isArray(loadedData.tenants) &&
                        Array.isArray(loadedData.finances))
                    {
                        // Limpiar datos antiguos antes de cargar nuevos
                        initializeEmptyData();

                        parkings = loadedData.parkings || [];
                        tenants = loadedData.tenants || [];
                        finances = loadedData.finances || [];

                        updateUI(); // Actualizar toda la interfaz con los nuevos datos
                        showNotification(`Datos cargados desde ${file.name}`, 'success');
                        // Ocultar mensaje inicial del dashboard
                        const dashMsg = document.getElementById('dashboard-message');
                        if (dashMsg) dashMsg.style.display = 'none';
                         // Activar la primera pestaña por defecto después de cargar datos
                        activateTab('dashboard');


                    } else {
                       showNotification('El archivo JSON no tiene el formato esperado (debe contener "parkings", "tenants", "finances").', 'danger');
                       initializeEmptyData(); // Resetear a vacío
                       updateUI();
                    }
                } catch (error) {
                    console.error("Error al parsear el archivo JSON:", error);
                    showNotification('Error al leer o procesar el archivo JSON.', 'danger');
                    initializeEmptyData(); // Resetear a vacío
                    updateUI();
                } finally {
                    // Resetear el input de archivo para permitir cargar el mismo archivo de nuevo si es necesario
                     event.target.value = null;
                }
            };

            reader.onerror = function() {
                 console.error("Error al leer el archivo:", reader.error);
                 showNotification('Error al leer el archivo.', 'danger');
            };

            reader.readAsText(file); // Leer el archivo como texto
        }

        // Función para iniciar la descarga del archivo JSON actualizado
        function saveDataToFile() {
             if (parkings.length === 0 && tenants.length === 0 && finances.length === 0) {
                showNotification('No hay datos para guardar.', 'info');
                return;
            }
            // Crear un objeto que contenga todos los datos actuales
            const allData = {
                parkings: parkings,
                tenants: tenants,
                finances: finances
            };

            // Convertir el objeto a una cadena JSON formateada
            const dataStr = JSON.stringify(allData, null, 2); // null, 2 para formatear

            // Crear un Blob con los datos JSON
            const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });

            // Crear una URL temporal para el Blob
            const url = URL.createObjectURL(dataBlob);

            // Crear un enlace temporal para iniciar la descarga
            const tempLink = document.createElement('a');
            tempLink.href = url;
            // Sugerir el mismo nombre de archivo para facilitar la sobreescritura
            tempLink.setAttribute('download', 'gestion_parking_datos.json');
            tempLink.style.display = 'none'; // Ocultar el enlace
            document.body.appendChild(tempLink); // Añadir al DOM para que funcione en Firefox

            tempLink.click(); // Simular clic para descargar

            document.body.removeChild(tempLink); // Limpiar el DOM
            // Limpiar la URL temporal
            URL.revokeObjectURL(url);

            showNotification('Guardando cambios... Por favor, guarda el archivo descargado (puedes sobrescribir el anterior).', 'success');
        }

        // Función auxiliar para inicializar datos vacíos
        function initializeEmptyData() {
            parkings = [];
            tenants = [];
            finances = [];
             // Mostrar mensaje inicial del dashboard si existe
            const dashMsg = document.getElementById('dashboard-message');
            if (dashMsg) dashMsg.style.display = 'block';
            // Limpiar tablas y stats si ya estaban renderizados
            updateUI(); // Llama a updateUI para limpiar todo
        }

        // --- Fin: Funciones para Cargar/Guardar Archivo Local ---


        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar los arrays vacíos al principio
            initializeEmptyData();

            // Configurar pestañas, modales y botones
            initTabs();
            initModals();
            initButtonEvents();

             // Inicializar UI (mostrará tablas vacías o mensajes "No hay datos")
             // Se llama dentro de initializeEmptyData y handleFileSelect
        });


        // Función para activar una pestaña específica
        function activateTab(tabId) {
             const tabBtns = document.querySelectorAll('.tab-btn');
             const tabContents = document.querySelectorAll('.tab-content');

             // Desactivar todas las pestañas visualmente
             tabBtns.forEach(b => b.querySelector('a').classList.remove('bg-blue-100', 'border-l', 'border-t', 'border-r', 'rounded-t'));
             // Ocultar todos los contenidos
             tabContents.forEach(content => content.classList.remove('active'));

             // Activar la pestaña seleccionada
             const targetBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
             const targetContent = document.getElementById(tabId);

             if (targetBtn && targetContent) {
                 targetBtn.querySelector('a').classList.add('bg-blue-100', 'border-l', 'border-t', 'border-r', 'rounded-t');
                 targetContent.classList.add('active');

                 // Actualizar contenido específico si es necesario
                 if (tabId === 'forecast' && parkings.length > 0) {
                     updateForecastData();
                 } else if (tabId === 'compound') {
                     // Podríamos calcular la proyección compuesta automáticamente al cambiar de pestaña,
                     // pero es mejor dejarlo al botón para controlar los parámetros.
                     // Solo limpiamos la tabla si no hay resultados.
                     if(document.getElementById('compoundForecastTable').rows.length <= 1) {
                         document.getElementById('compoundForecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Ajusta parámetros y calcula la proyección.</td></tr>`;
                     }
                 } else if (tabId === 'dashboard') {
                      updateDashboardStats(); // Re-calcular stats al volver al dashboard
                 }
             } else {
                 console.error(`No se encontró la pestaña o contenido para el ID: ${tabId}`);
                 // Activar la primera pestaña como fallback
                 const firstTabBtn = tabBtns[0];
                 const firstTabContent = tabContents[0];
                 if(firstTabBtn && firstTabContent) {
                     firstTabBtn.querySelector('a').classList.add('bg-blue-100', 'border-l', 'border-t', 'border-r', 'rounded-t');
                     firstTabContent.classList.add('active');
                 }
             }
        }


        // Inicializar pestañas
        function initTabs() {
             const tabBtns = document.querySelectorAll('.tab-btn');
             tabBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
             });
              // Activar la primera pestaña al inicio
             const firstTabId = tabBtns[0]?.getAttribute('data-tab') || 'dashboard';
             activateTab(firstTabId);
        }

        // Inicializar modales
        function initModals() {
            // --- Parking Modal ---
            const parkingModal = document.getElementById('parkingModal');
            document.getElementById('addParkingBtn').addEventListener('click', () => openParkingModal());
            document.getElementById('quickAddParking').addEventListener('click', () => openParkingModal());
            document.getElementById('closeParkingModal').addEventListener('click', () => parkingModal.classList.add('hidden'));
            document.getElementById('cancelParkingBtn').addEventListener('click', () => parkingModal.classList.add('hidden'));
            // Cerrar modal al hacer clic fuera
            parkingModal.addEventListener('click', (event) => {
                if (event.target === parkingModal) {
                    parkingModal.classList.add('hidden');
                }
            });


            // --- Tenant Modal ---
            const tenantModal = document.getElementById('tenantModal');
            document.getElementById('addTenantBtn').addEventListener('click', () => openTenantModal());
            document.getElementById('quickAddTenant').addEventListener('click', () => openTenantModal());
            document.getElementById('closeTenantModal').addEventListener('click', () => tenantModal.classList.add('hidden'));
            document.getElementById('cancelTenantBtn').addEventListener('click', () => tenantModal.classList.add('hidden');
            tenantModal.addEventListener('click', (event) => {
                 if (event.target === tenantModal) {
                    tenantModal.classList.add('hidden');
                 }
             });

            // --- Finance Modal ---
             const financeModal = document.getElementById('financeModal');
             document.getElementById('addIncomeBtn').addEventListener('click', () => openFinanceModal('income'));
             document.getElementById('quickAddIncome').addEventListener('click', () => openFinanceModal('income'));
             document.getElementById('addExpenseBtn').addEventListener('click', () => openFinanceModal('expense'));
             document.getElementById('quickAddExpense').addEventListener('click', () => openFinanceModal('expense'));
             document.getElementById('closeFinanceModal').addEventListener('click', () => financeModal.classList.add('hidden'));
             document.getElementById('cancelFinanceBtn').addEventListener('click', () => financeModal.classList.add('hidden');
             financeModal.addEventListener('click', (event) => {
                 if (event.target === financeModal) {
                     financeModal.classList.add('hidden');
                 }
             });

            // Inicializar formularios
            initForms();
        }

        // Inicializar formularios
        function initForms() {
            // Formulario de parking
            document.getElementById('parkingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveParking();
            });

            // Formulario de inquilino
            document.getElementById('tenantForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTenant();
            });

            // Formulario de finanzas
            document.getElementById('financeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveFinance();
            });
        }

       // Inicializar eventos de botones (incluye carga/guardado de archivo)
       function initButtonEvents() {
            // --- Carga/Guardado Archivo ---
            document.getElementById('loadDataBtn').addEventListener('click', () => document.getElementById('loadDataInput').click());
            document.getElementById('loadDataInput').addEventListener('change', handleFileSelect);
            document.getElementById('saveDataToFileBtn').addEventListener('click', saveDataToFile);

            // --- Previsiones ---
            document.getElementById('calculateForecastBtn').addEventListener('click', () => {
                if (parkings.length > 0) updateForecastData();
                else showNotification('Carga datos primero para calcular previsiones.', 'warning');
            });

            // --- Proyección Compuesta ---
            document.getElementById('calculateCompoundForecastBtn').addEventListener('click', calculateCompoundForecast);
            document.getElementById('addInvestmentRowBtn').addEventListener('click', addFutureInvestmentRow);
            document.getElementById('futureInvestmentsContainer').addEventListener('click', function(event) {
                if (event.target.closest('.remove-investment-btn')) {
                    const container = document.getElementById('futureInvestmentsContainer');
                    if (container.querySelectorAll('.future-investment-row').length > 1) {
                         event.target.closest('.future-investment-row').remove();
                    } else {
                        const row = event.target.closest('.future-investment-row');
                        row.querySelector('.future-investment-year').value = '';
                        row.querySelector('.future-investment-cost').value = '';
                        showNotification('Fila limpiada. Añade otra si necesitas más.', 'info');
                    }
                }
            });


            // --- Filtros y Ordenación ---
            // Parkings
            document.getElementById('searchParking').addEventListener('input', updateParkingsTable);
            document.getElementById('filterParkingStatus').addEventListener('change', updateParkingsTable);
            document.getElementById('sortParkings').addEventListener('change', updateParkingsTable);
            // Inquilinos
            document.getElementById('searchTenant').addEventListener('input', updateTenantsTable);
            document.getElementById('sortTenants').addEventListener('change', updateTenantsTable);
            // Finanzas
            document.getElementById('financesPeriod').addEventListener('change', updateFinancesTable);
            document.getElementById('financesParkingFilter').addEventListener('change', updateFinancesTable);
            document.getElementById('financeType').addEventListener('change', updateFinancesTable);


            // --- Acciones Rápidas (ya vinculadas a abrir modales en initModals) ---
            // (No se necesita código adicional aquí si solo abren modales)

            // --- Modo Oscuro ---
            document.getElementById('darkModeToggle').addEventListener('click', function() {
                document.body.classList.toggle('dark');
                const isDarkMode = document.body.classList.contains('dark');
                // Opcional: Guardar preferencia en localStorage
                // localStorage.setItem('darkMode', isDarkMode);
                // Actualizar icono
                this.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
                showNotification(`Modo ${isDarkMode ? 'Oscuro' : 'Claro'} activado.`, 'info');
            });
             // Opcional: Cargar preferencia de modo oscuro al inicio
             // if (localStorage.getItem('darkMode') === 'true') {
             //     document.body.classList.add('dark');
             //     document.getElementById('darkModeToggle').querySelector('i').className = 'fas fa-sun';
             // }
        }


        // ===== FUNCIONES DE ACTUALIZACIÓN DE UI =====

        function updateUI() {
            updateParkingsTable();
            updateTenantsTable();
            updateFinancesTable(); // Esto también recalcula y actualiza el ROI TTM y totales
            updateParkingDropdowns();
            updateDashboardStats(); // Recalcula stats del dashboard
             // Limpiar/resetear tablas de previsiones si no hay datos
            if (parkings.length === 0) {
                 document.getElementById('forecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Carga datos primero.</td></tr>`;
                 document.getElementById('compoundForecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Carga datos primero.</td></tr>`;
                 // Limpiar gráfico si existe
                 if (window.forecastChartInstance) {
                    window.forecastChartInstance.destroy();
                    window.forecastChartInstance = null; // Resetear la instancia
                 }
            }
        }

        function updateParkingsTable() {
            const tableBody = document.getElementById('parkingsTable');
            const searchTerm = document.getElementById('searchParking').value.toLowerCase();
            const statusFilter = document.getElementById('filterParkingStatus').value;
            const sortBy = document.getElementById('sortParkings').value;

            let filteredParkings = [...parkings];

            if (searchTerm) {
                filteredParkings = filteredParkings.filter(p => p.location.toLowerCase().includes(searchTerm));
            }

            if (statusFilter !== 'all') {
                const isOccupiedFilter = statusFilter === 'occupied';
                filteredParkings = filteredParkings.filter(p => {
                    const hasTenant = tenants.some(t => t.parkingId === p.id);
                    return hasTenant === isOccupiedFilter;
                });
            }

            filteredParkings.sort((a, b) => {
                switch (sortBy) {
                    case 'location': return a.location.localeCompare(b.location);
                    case 'price': return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                    case 'size': return (parseFloat(a.size) || 0) - (parseFloat(b.size) || 0);
                    default: return 0;
                }
            });

            tableBody.innerHTML = ''; // Limpiar tabla

            if (filteredParkings.length === 0) {
                 const message = parkings.length === 0 ? 'Carga datos o añade un parking.' : 'No hay parkings que coincidan.';
                 tableBody.innerHTML = `<tr><td colspan="8" class="py-4 px-4 text-center text-gray-500">${message}</td></tr>`;
            } else {
                filteredParkings.forEach(parking => {
                    const tenant = tenants.find(t => t.parkingId === parking.id);
                    const status = tenant ? 'Ocupado' : 'Disponible';
                    const statusClass = tenant ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b text-sm">${parking.id}</td>
                        <td class="py-3 px-4 border-b font-medium">${parking.location}</td>
                        <td class="py-3 px-4 border-b text-right">${parking.size || '-'} m²</td>
                        <td class="py-3 px-4 border-b text-sm">${parking.features || '-'}</td>
                        <td class="py-3 px-4 border-b text-right font-semibold">${formatCurrency(parking.price)}</td>
                        <td class="py-3 px-4 border-b text-center"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${status}</span></td>
                        <td class="py-3 px-4 border-b">${tenant ? tenant.name : '-'}</td>
                        <td class="py-3 px-4 border-b text-center">
                            <div class="flex justify-center space-x-3">
                                <button class="text-blue-500 hover:text-blue-700" onclick="editParking('${parking.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteParking('${parking.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                                ${!tenant ? `<button class="text-green-500 hover:text-green-700" onclick="assignTenant('${parking.id}')" title="Asignar Inquilino"><i class="fas fa-user-plus"></i></button>` : ''}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            updateRecentParkings(); // Actualizar dashboard
        }

        function updateRecentParkings() {
            const recentTable = document.getElementById('recentParkingsTable');
            recentTable.innerHTML = '';

            if (parkings.length === 0) {
                recentTable.innerHTML = `<tr><td colspan="3" class="py-4 px-4 text-center text-gray-500">Carga datos primero.</td></tr>`;
                return;
            }

            const recentParkings = [...parkings]
                .sort((a, b) => (b.createdAt || '') < (a.createdAt || '') ? -1 : 1) // Ordenar por fecha de creación (si existe)
                .slice(0, 5);

            if (recentParkings.length === 0) {
                 recentTable.innerHTML = `<tr><td colspan="3" class="py-4 px-4 text-center text-gray-500">No hay parkings.</td></tr>`;
                 return;
            }

            recentParkings.forEach(parking => {
                const tenant = tenants.find(t => t.parkingId === parking.id);
                const status = tenant ? 'Ocupado' : 'Disponible';
                const statusClass = tenant ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${parking.location}</td>
                    <td class="py-2 px-4 border-b"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${status}</span></td>
                    <td class="py-2 px-4 border-b text-right">${formatCurrency(parking.price)}</td>
                `;
                recentTable.appendChild(row);
            });
        }

        function updateTenantsTable() {
            const tableBody = document.getElementById('tenantsTable');
            const searchTerm = document.getElementById('searchTenant').value.toLowerCase();
            const sortBy = document.getElementById('sortTenants').value;

            let filteredTenants = [...tenants];

            if (searchTerm) {
                filteredTenants = filteredTenants.filter(t => t.name.toLowerCase().includes(searchTerm));
            }

            filteredTenants.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'startDate':
                        const dateA = a.startDate ? new Date(a.startDate) : 0;
                        const dateB = b.startDate ? new Date(b.startDate) : 0;
                        return dateA - dateB;
                    default: return 0;
                }
            });

            tableBody.innerHTML = ''; // Limpiar

             if (filteredTenants.length === 0) {
                 const message = tenants.length === 0 ? 'Carga datos o añade un inquilino.' : 'No hay inquilinos que coincidan.';
                 tableBody.innerHTML = `<tr><td colspan="8" class="py-4 px-4 text-center text-gray-500">${message}</td></tr>`;
            } else {
                filteredTenants.forEach(tenant => {
                    const parking = parkings.find(p => p.id === tenant.parkingId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b text-sm">${tenant.id}</td>
                        <td class="py-3 px-4 border-b font-medium">${tenant.name}</td>
                        <td class="py-3 px-4 border-b">${tenant.phone}</td>
                        <td class="py-3 px-4 border-b">${tenant.email || '-'}</td>
                        <td class="py-3 px-4 border-b">${parking ? parking.location : (tenant.parkingId ? `ID: ${tenant.parkingId}` : 'Ninguno')}</td>
                        <td class="py-3 px-4 border-b text-center">${formatDate(tenant.startDate)}</td>
                        <td class="py-3 px-4 border-b text-center">${tenant.endDate ? formatDate(tenant.endDate) : '-'}</td>
                        <td class="py-3 px-4 border-b text-center">
                            <div class="flex justify-center space-x-3">
                                <button class="text-blue-500 hover:text-blue-700" onclick="editTenant('${tenant.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteTenant('${tenant.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        function updateFinancesTable() {
            const tableBody = document.getElementById('financesTable');
            const periodFilter = document.getElementById('financesPeriod').value;
            const parkingFilter = document.getElementById('financesParkingFilter').value;
            const typeFilter = document.getElementById('financeType').value;

            let filteredFinances = [...finances];

            if (periodFilter !== 'all') {
                const today = new Date();
                const startDate = new Date(today);
                switch (periodFilter) {
                    case 'month': startDate.setMonth(today.getMonth() - 1); break;
                    case 'quarter': startDate.setMonth(today.getMonth() - 3); break;
                    case 'year': startDate.setFullYear(today.getFullYear() - 1); break;
                }
                startDate.setHours(0, 0, 0, 0);
                filteredFinances = filteredFinances.filter(f => f.date && new Date(f.date) >= startDate);
            }

            if (parkingFilter !== 'all') {
                filteredFinances = filteredFinances.filter(f => f.parkingId === parkingFilter);
            }
            if (typeFilter !== 'all') {
                filteredFinances = filteredFinances.filter(f => f.type === typeFilter);
            }

            filteredFinances.sort((a, b) => (b.date ? new Date(b.date) : 0) - (a.date ? new Date(a.date) : 0));

            tableBody.innerHTML = ''; // Limpiar

             if (filteredFinances.length === 0) {
                 const message = finances.length === 0 ? 'Carga datos o registra movimientos.' : 'No hay movimientos que coincidan.';
                 tableBody.innerHTML = `<tr><td colspan="6" class="py-4 px-4 text-center text-gray-500">${message}</td></tr>`;
             } else {
                 filteredFinances.forEach(finance => {
                    const parking = parkings.find(p => p.id === finance.parkingId);
                    const typeClass = finance.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const typeIcon = finance.type === 'income' ? 'fa-plus-circle' : 'fa-minus-circle';
                    const typeText = finance.type === 'income' ? 'Ingreso' : 'Gasto';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b text-center">${formatDate(finance.date)}</td>
                        <td class="py-3 px-4 border-b ${typeClass}">
                            <i class="fas ${typeIcon} mr-1"></i> ${typeText}
                        </td>
                        <td class="py-3 px-4 border-b">${finance.concept}</td>
                        <td class="py-3 px-4 border-b">${parking ? parking.location : (finance.parkingId ? `ID: ${finance.parkingId}` : 'General')}</td>
                        <td class="py-3 px-4 border-b text-right ${typeClass} font-semibold">${formatCurrency(finance.amount)}</td>
                        <td class="py-3 px-4 border-b text-center">
                            <div class="flex justify-center space-x-3">
                                <button class="text-blue-500 hover:text-blue-700" onclick="editFinance('${finance.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteFinance('${finance.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Recalcular totales y ROI TTM (basado en *todos* los datos, no los filtrados)
            let totalIncome = 0;
            let totalExpenses = 0;
            finances.forEach(f => {
                const amount = parseFloat(f.amount) || 0;
                if (f.type === 'income') totalIncome += amount;
                else totalExpenses += amount;
            });
            const totalBalance = totalIncome - totalExpenses;

            let roiTTM = 0;
            const todayForROI = new Date();
            const currentInvestment = parkings.reduce((sum, p) => {
                const price = parseFloat(p.purchasePrice) || 0;
                const pDate = p.purchaseDate ? new Date(p.purchaseDate) : null;
                return (price > 0 && (!pDate || pDate <= todayForROI)) ? sum + price : sum;
            }, 0);

            if (currentInvestment > 0) {
                const twelveMonthsAgo = new Date(todayForROI); twelveMonthsAgo.setFullYear(todayForROI.getFullYear() - 1); twelveMonthsAgo.setHours(0, 0, 0, 0);
                let incomeLast12Months = 0;
                let expensesLast12Months = 0;
                finances.forEach(f => {
                    if (!f.date) return;
                    try {
                        const tDate = new Date(f.date);
                        if (!isNaN(tDate) && tDate >= twelveMonthsAgo && tDate <= todayForROI) {
                            const amount = parseFloat(f.amount) || 0;
                            if (f.type === 'income') incomeLast12Months += amount;
                            else if (f.type === 'expense') expensesLast12Months += amount;
                        }
                    } catch (e) { console.warn("Fecha inválida en cálculo TTM ROI:", f.date); }
                });
                const balanceLast12Months = incomeLast12Months - expensesLast12Months;
                roiTTM = (balanceLast12Months / currentInvestment) * 100;
            }

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('annualROI').textContent = isFinite(roiTTM) ? `${roiTTM.toFixed(2)}%` : 'N/A';
        }

        function updateParkingDropdowns() {
            const tenantParkingSelect = document.getElementById('tenantParking');
            const financeParkingSelect = document.getElementById('financeParking');
            const financesParkingFilter = document.getElementById('financesParkingFilter');

            const currentTenantValue = tenantParkingSelect.value;
            const currentFinanceValue = financeParkingSelect.value;
            const currentFilterValue = financesParkingFilter.value;

            const selects = [tenantParkingSelect, financeParkingSelect, financesParkingFilter];
            selects.forEach(select => {
                const firstOption = select.options[0].cloneNode(true);
                select.innerHTML = '';
                select.appendChild(firstOption);
            });

            [...parkings].sort((a, b) => a.location.localeCompare(b.location)).forEach(parking => {
                const isOccupied = tenants.some(t => t.parkingId === parking.id);
                const tenantIdBeingEdited = document.getElementById('tenantId').value;
                const isAssignedToCurrentTenant = tenantIdBeingEdited && tenants.find(t => t.id === tenantIdBeingEdited)?.parkingId === parking.id;

                // Opción para filtro de finanzas y modal de finanzas (todos)
                const financeOption = document.createElement('option');
                financeOption.value = parking.id;
                financeOption.textContent = parking.location;
                financeParkingSelect.appendChild(financeOption.cloneNode(true));
                financesParkingFilter.appendChild(financeOption);


                // Opción para modal de inquilino (solo disponibles o el suyo)
                if (!isOccupied || isAssignedToCurrentTenant) {
                    const tenantOption = document.createElement('option');
                    tenantOption.value = parking.id;
                    tenantOption.textContent = `${parking.location} (${formatCurrency(parking.price)}/mes)`;
                    tenantParkingSelect.appendChild(tenantOption);
                }
            });

            // Restaurar selecciones anteriores si es posible
            tenantParkingSelect.value = currentTenantValue;
            financeParkingSelect.value = currentFinanceValue;
            financesParkingFilter.value = currentFilterValue;
        }

        function updateDashboardStats() {
             if (parkings.length === 0 && tenants.length === 0 && finances.length === 0) {
                document.getElementById('totalParkings').textContent = '0';
                document.getElementById('occupiedParkings').textContent = '0';
                document.getElementById('monthlyIncome').textContent = '0 €';
                document.getElementById('monthlyExpenses').textContent = '0 €';
                return;
            }

            document.getElementById('totalParkings').textContent = parkings.length;

            const occupiedCount = tenants.filter(t => parkings.some(p => p.id === t.parkingId)).length;
            document.getElementById('occupiedParkings').textContent = occupiedCount;

            let monthlyIncome = 0;
            tenants.forEach(tenant => {
                const parking = parkings.find(p => p.id === tenant.parkingId);
                if (parking) monthlyIncome += parseFloat(parking.price || 0);
            });
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            let totalCurrentMonthExpenses = 0;
            finances.forEach(f => {
                 if (f.type !== 'expense' || !f.date) return;
                 try {
                    const tDate = new Date(f.date);
                    if (!isNaN(tDate) && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                        totalCurrentMonthExpenses += parseFloat(f.amount || 0);
                    }
                 } catch (e) { console.warn("Fecha inválida en finanzas (dashboard):", f.date); }
            });
            document.getElementById('monthlyExpenses').textContent = formatCurrency(totalCurrentMonthExpenses);
        }


        // ===== FUNCIONES CRUD (Añadir/Editar/Borrar) =====
        // (Estas funciones modifican los arrays en memoria; los cambios se guardan en archivo con el botón 'Guardar Cambios')

        function openParkingModal(parkingId = null) {
            const modal = document.getElementById('parkingModal');
            const modalTitle = document.getElementById('parkingModalTitle');
            const form = document.getElementById('parkingForm');
            form.reset();
            document.getElementById('parkingId').value = '';

            if (parkingId) {
                const parking = parkings.find(p => p.id === parkingId);
                if (parking) {
                    modalTitle.textContent = 'Editar Parking';
                    document.getElementById('parkingId').value = parking.id;
                    document.getElementById('parkingLocation').value = parking.location;
                    document.getElementById('parkingSize').value = parking.size;
                    document.getElementById('parkingPrice').value = parking.price;
                    document.getElementById('parkingFeatures').value = parking.features || '';
                    document.getElementById('parkingPurchasePrice').value = parking.purchasePrice || '';
                    document.getElementById('parkingPurchaseDate').value = parking.purchaseDate || '';
                } else { showNotification(`Parking ID ${parkingId} no encontrado.`, 'danger'); return; }
            } else { modalTitle.textContent = 'Añadir Nuevo Parking'; }
            modal.classList.remove('hidden');
            document.getElementById('parkingLocation').focus();
        }

        function saveParking() {
            const idInput = document.getElementById('parkingId');
            const isEditing = !!idInput.value;
            const id = idInput.value || 'p_' + Date.now() + Math.random().toString(16).slice(2);
            const location = document.getElementById('parkingLocation').value.trim();
            const size = document.getElementById('parkingSize').value;
            const price = document.getElementById('parkingPrice').value;
            const features = document.getElementById('parkingFeatures').value.trim();
            const purchasePrice = document.getElementById('parkingPurchasePrice').value;
            const purchaseDate = document.getElementById('parkingPurchaseDate').value;

            if (!location || !size || !price) { showNotification('Ubicación, Tamaño y Precio son requeridos.', 'warning'); return; }

            const parkingData = {
                id, location, size: parseFloat(size), price: parseFloat(price), features,
                purchasePrice: purchasePrice ? parseFloat(purchasePrice) : null,
                purchaseDate: purchaseDate || null,
                createdAt: isEditing ? parkings.find(p => p.id === id)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const existingIndex = parkings.findIndex(p => p.id === id);
            if (existingIndex >= 0) {
                parkingData.createdAt = parkings[existingIndex].createdAt || parkingData.createdAt;
                parkings[existingIndex] = parkingData;
                showNotification('Parking actualizado (pendiente de guardar).', 'info');
            } else {
                parkings.push(parkingData);
                showNotification('Nuevo parking añadido (pendiente de guardar).', 'info');
            }
            updateUI();
            document.getElementById('parkingModal').classList.add('hidden');
        }

        function editParking(parkingId) { openParkingModal(parkingId); }

        function assignTenant(parkingId) { openTenantModal(null, parkingId); }

        function deleteParking(parkingId) {
             const parking = parkings.find(p => p.id === parkingId);
             if (!parking) { showNotification(`Parking ID ${parkingId} no encontrado.`, 'warning'); return; }
             if (!confirm(`¿Eliminar parking "${parking.location}"? El inquilino asociado (si existe) será desvinculado. Cambios pendientes de guardar.`)) return;

            const associatedTenantIndex = tenants.findIndex(t => t.parkingId === parkingId);
            if (associatedTenantIndex > -1) {
                tenants[associatedTenantIndex].parkingId = null;
                tenants[associatedTenantIndex].updatedAt = new Date().toISOString();
                showNotification(`Inquilino "${tenants[associatedTenantIndex].name}" desvinculado.`, 'info');
            }

            parkings = parkings.filter(p => p.id !== parkingId);
            updateUI();
            showNotification(`Parking "${parking.location}" eliminado (pendiente de guardar).`, 'info');
        }

        function openTenantModal(tenantId = null, preSelectedParkingId = null) {
            const modal = document.getElementById('tenantModal');
            const modalTitle = document.getElementById('tenantModalTitle');
            const form = document.getElementById('tenantForm');
            const tenantParkingSelect = document.getElementById('tenantParking');
            form.reset();
            document.getElementById('tenantId').value = '';
            updateParkingDropdowns(); // Actualizar lista antes de todo
            const today = new Date().toISOString().split('T')[0];

            if (tenantId) {
                const tenant = tenants.find(t => t.id === tenantId);
                if (tenant) {
                    modalTitle.textContent = 'Editar Inquilino';
                    document.getElementById('tenantId').value = tenant.id;
                    document.getElementById('tenantName').value = tenant.name;
                    document.getElementById('tenantPhone').value = tenant.phone;
                    document.getElementById('tenantEmail').value = tenant.email || '';
                    tenantParkingSelect.value = tenant.parkingId || ""; // Seleccionar parking actual
                    document.getElementById('tenantStartDate').value = tenant.startDate || today;
                    document.getElementById('tenantEndDate').value = tenant.endDate || '';
                    document.getElementById('tenantNotes').value = tenant.notes || '';
                } else { showNotification(`Inquilino ID ${tenantId} no encontrado.`, 'danger'); return; }
            } else {
                modalTitle.textContent = 'Añadir Nuevo Inquilino';
                document.getElementById('tenantStartDate').value = today;
                if (preSelectedParkingId) {
                    const parkingExists = parkings.some(p => p.id === preSelectedParkingId);
                    const parkingAvailable = !tenants.some(t => t.parkingId === preSelectedParkingId);
                    if (parkingExists && parkingAvailable) tenantParkingSelect.value = preSelectedParkingId;
                    else if (parkingExists) showNotification('Parking seleccionado ya ocupado.', 'warning');
                    else showNotification('Parking de origen no encontrado.', 'warning');
                }
            }
            modal.classList.remove('hidden');
            document.getElementById('tenantName').focus();
        }

        function saveTenant() {
            const idInput = document.getElementById('tenantId');
            const isEditing = !!idInput.value;
            const id = idInput.value || 't_' + Date.now() + Math.random().toString(16).slice(2);
            const name = document.getElementById('tenantName').value.trim();
            const phone = document.getElementById('tenantPhone').value.trim();
            const email = document.getElementById('tenantEmail').value.trim();
            const parkingId = document.getElementById('tenantParking').value || null;
            const startDate = document.getElementById('tenantStartDate').value;
            const endDate = document.getElementById('tenantEndDate').value || null;
            const notes = document.getElementById('tenantNotes').value.trim();

            if (!name || !phone || !startDate || !parkingId) { // Parking es ahora requerido
                showNotification('Nombre, Teléfono, Fecha Inicio y Parking Asignado son requeridos.', 'warning'); return;
            }
            if (endDate && new Date(endDate) < new Date(startDate)) {
                showNotification('Fecha Fin no puede ser anterior a Fecha Inicio.', 'warning'); return;
            }
            const existingTenant = tenants.find(t => t.parkingId === parkingId && t.id !== id);
            if (existingTenant) {
                showNotification(`Parking ya asignado a "${existingTenant.name}". Elija otro.`, 'danger'); return;
            }

            const tenantData = {
                id, name, phone, email: email || null, parkingId, startDate, endDate, notes,
                createdAt: isEditing ? tenants.find(t => t.id === id)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            let autoGeneratedIncome = false;
            const existingIndex = tenants.findIndex(t => t.id === id);
            if (existingIndex >= 0) {
                tenantData.createdAt = tenants[existingIndex].createdAt || tenantData.createdAt;
                tenants[existingIndex] = tenantData;
                showNotification('Inquilino actualizado (pendiente de guardar).', 'info');
            } else {
                tenants.push(tenantData);
                showNotification('Nuevo inquilino añadido (pendiente de guardar).', 'info');
                const parking = parkings.find(p => p.id === parkingId);
                if (parking && parking.price > 0) {
                    const financeData = {
                        id: 'f_' + Date.now() + Math.random().toString(16).slice(2), date: startDate, type: 'income',
                        concept: `Alquiler inicial - ${name}`, parkingId: parkingId, amount: parking.price,
                        notes: `Pago inicial automático al añadir inquilino ${name}.`, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
                    };
                    finances.push(financeData);
                    autoGeneratedIncome = true;
                }
            }
            updateUI();
            document.getElementById('tenantModal').classList.add('hidden');
            if (autoGeneratedIncome) {
                showNotification('Ingreso automático por primer alquiler añadido (pendiente de guardar).', 'success');
            }
        }

        function editTenant(tenantId) { openTenantModal(tenantId); }

        function deleteTenant(tenantId) {
            const tenant = tenants.find(t => t.id === tenantId);
            if (!tenant) { showNotification(`Inquilino ID ${tenantId} no encontrado.`, 'warning'); return; }
            if (!confirm(`¿Eliminar inquilino "${tenant.name}"? Cambios pendientes de guardar.`)) return;
            tenants = tenants.filter(t => t.id !== tenantId);
            updateUI();
            showNotification(`Inquilino "${tenant.name}" eliminado (pendiente de guardar).`, 'info');
        }


        function openFinanceModal(type, financeId = null) {
            const modal = document.getElementById('financeModal');
            const modalTitle = document.getElementById('financeModalTitle');
            const form = document.getElementById('financeForm');
            const saveBtn = document.getElementById('saveFinanceBtn');
            form.reset();
            document.getElementById('financeId').value = '';
            document.getElementById('financeTransactionType').value = type;
            updateParkingDropdowns();
            const today = new Date().toISOString().split('T')[0];

            if (financeId) {
                const finance = finances.find(f => f.id === financeId);
                if (finance) {
                    type = finance.type; // Usar el tipo real para título y botón
                    document.getElementById('financeId').value = finance.id;
                    document.getElementById('financeTransactionType').value = finance.type;
                    document.getElementById('financeDate').value = finance.date || today;
                    document.getElementById('financeConcept').value = finance.concept;
                    document.getElementById('financeParking').value = finance.parkingId || '';
                    document.getElementById('financeAmount').value = finance.amount;
                    document.getElementById('financeNotes').value = finance.notes || '';
                } else { showNotification(`Transacción ID ${financeId} no encontrada.`, 'danger'); return; }
            } else { document.getElementById('financeDate').value = today; }

            if (type === 'income') {
                modalTitle.textContent = financeId ? 'Editar Ingreso' : 'Registrar Ingreso';
                saveBtn.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded btn-animated transition flex items-center'; // Añadir flex items-center
                saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>${financeId ? 'Guardar Ingreso' : 'Registrar Ingreso'}`;
            } else {
                modalTitle.textContent = financeId ? 'Editar Gasto' : 'Registrar Gasto';
                saveBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded btn-animated transition flex items-center'; // Añadir flex items-center
                saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>${financeId ? 'Guardar Gasto' : 'Registrar Gasto'}`;
            }

            modal.classList.remove('hidden');
            document.getElementById('financeConcept').focus();
        }

        function saveFinance() {
            const idInput = document.getElementById('financeId');
            const isEditing = !!idInput.value;
            const id = idInput.value || 'f_' + Date.now() + Math.random().toString(16).slice(2);
            const type = document.getElementById('financeTransactionType').value;
            const date = document.getElementById('financeDate').value;
            const concept = document.getElementById('financeConcept').value.trim();
            const parkingId = document.getElementById('financeParking').value || null;
            const amount = document.getElementById('financeAmount').value;
            const notes = document.getElementById('financeNotes').value.trim();

            if (!date || !concept || !amount || parseFloat(amount) <= 0) {
                showNotification('Fecha, Concepto e Importe (mayor a 0) son requeridos.', 'warning'); return;
            }

            const financeData = {
                id, type, date, concept, parkingId, amount: parseFloat(amount), notes,
                createdAt: isEditing ? finances.find(f => f.id === id)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const existingIndex = finances.findIndex(f => f.id === id);
            if (existingIndex >= 0) {
                financeData.createdAt = finances[existingIndex].createdAt || financeData.createdAt;
                finances[existingIndex] = financeData;
                showNotification('Transacción actualizada (pendiente de guardar).', 'info');
            } else {
                finances.push(financeData);
                showNotification(`${type === 'income' ? 'Ingreso' : 'Gasto'} registrado (pendiente de guardar).`, 'info');
            }
            updateUI();
            document.getElementById('financeModal').classList.add('hidden');
        }

        function editFinance(financeId) { openFinanceModal(null, financeId); }

        function deleteFinance(financeId) {
            const finance = finances.find(f => f.id === financeId);
            if (!finance) { showNotification(`Transacción ID ${financeId} no encontrada.`, 'warning'); return; }
            if (!confirm(`¿Eliminar transacción "${finance.concept}" (${formatCurrency(finance.amount)})? Cambios pendientes de guardar.`)) return;
            finances = finances.filter(f => f.id !== financeId);
            updateUI();
            showNotification('Transacción eliminada (pendiente de guardar).', 'info');
        }


        // ===== FUNCIONES DE PREVISIÓN (SIMPLE Y COMPUESTA) =====

        // Variable global para la instancia del gráfico de previsión simple
        window.forecastChartInstance = null;

        function updateForecastData() { // Previsión Simple
             if (parkings.length === 0) {
                 showNotification('Carga datos para calcular previsiones.', 'warning');
                 document.getElementById('forecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Carga datos primero.</td></tr>`;
                 if (window.forecastChartInstance) { window.forecastChartInstance.destroy(); window.forecastChartInstance = null; }
                 return;
             }
             try {
                 const forecastData = calculateSimpleForecastData(); // Usa la función auxiliar
                 updateForecastTable(forecastData);
                 updateForecastChart(forecastData);
             } catch (error) {
                  showNotification(`Error al calcular previsión simple: ${error.message}`, 'danger');
                  console.error("Error en updateForecastData:", error);
                  document.getElementById('forecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Error al calcular. ${error.message}</td></tr>`;
                  if (window.forecastChartInstance) { window.forecastChartInstance.destroy(); window.forecastChartInstance = null; }
             }
        }

        function updateForecastTable(forecastData) { // Tabla Previsión Simple
            const tableBody = document.getElementById('forecastTable');
            tableBody.innerHTML = '';
            if (!forecastData || forecastData.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No se generaron datos de previsión.</td></tr>`;
                 return;
            }
            forecastData.forEach(yearData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4 border-b">${yearData.year}</td>
                    <td class="py-3 px-4 border-b text-right text-green-600 dark:text-green-400 font-semibold">${formatCurrency(yearData.income)}</td>
                    <td class="py-3 px-4 border-b text-right text-red-600 dark:text-red-400 font-semibold">${formatCurrency(yearData.expenses)}</td>
                    <td class="py-3 px-4 border-b text-right font-bold ${yearData.balance >= 0 ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${formatCurrency(yearData.balance)}</td>
                    <td class="py-3 px-4 border-b text-right font-semibold">${yearData.roi.toFixed(2)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateForecastChart(forecastData) { // Gráfico Previsión Simple
            const canvas = document.getElementById('forecastChart');
             if (!canvas) return;
             const ctx = canvas.getContext('2d');
            if (window.forecastChartInstance) { window.forecastChartInstance.destroy(); }
             if (!forecastData || forecastData.length === 0) {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 ctx.textAlign = 'center'; ctx.fillStyle = document.body.classList.contains('dark') ? '#a0aec0' : '#4a5568';
                 ctx.fillText('Calcula la previsión para ver el gráfico.', canvas.width/2, canvas.height/2);
                 window.forecastChartInstance = null;
                 return;
             }
            const labels = forecastData.map(data => data.year);
            const options = { /* ... (opciones del gráfico, iguales que antes) ... */
                 responsive: true, maintainAspectRatio: false,
                 scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } }, x: { grid: { display: false } } },
                 plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}` } }, legend: { position: 'top' } },
                 interaction: { mode: 'index', intersect: false }
             };
            window.forecastChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Ingresos', data: forecastData.map(d => d.income), backgroundColor: 'rgba(72, 187, 120, 0.6)', borderColor: 'rgb(72, 187, 120)', borderWidth: 1, order: 2 },
                        { label: 'Gastos', data: forecastData.map(d => d.expenses), backgroundColor: 'rgba(245, 101, 101, 0.6)', borderColor: 'rgb(245, 101, 101)', borderWidth: 1, order: 3 },
                        { label: 'Balance', data: forecastData.map(d => d.balance), type: 'line', fill: false, borderColor: 'rgb(66, 153, 225)', borderWidth: 3, tension: 0.1, pointRadius: 4, order: 1 }
                    ]
                }, options: options
            });
        }

        // --- Funciones para la Proyección Compuesta ---

        function addFutureInvestmentRow() {
            const container = document.getElementById('futureInvestmentsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'flex items-center space-x-2 future-investment-row';
            newRow.innerHTML = `
                <input type="number" min="${new Date().getFullYear()}" placeholder="Año" class="shadow appearance-none border rounded w-1/3 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 future-investment-year">
                <input type="number" min="0" step="100" placeholder="Coste (€)" class="shadow appearance-none border rounded w-1/3 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 future-investment-cost">
                <button type="button" class="text-red-500 hover:text-red-700 remove-investment-btn p-2" title="Eliminar Inversión">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(newRow);
        }

        function calculateCompoundForecast() {
            try { // Envolver todo en try-catch
                const profitGrowthRateInput = document.getElementById('compoundProfitGrowthRate');
                const profitGrowthRate = (parseFloat(profitGrowthRateInput.value) || 0) / 100;

                const futureInvestments = [];
                document.querySelectorAll('.future-investment-row').forEach(row => {
                    const year = parseInt(row.querySelector('.future-investment-year').value);
                    const cost = parseFloat(row.querySelector('.future-investment-cost').value);
                    if (year && cost > 0) futureInvestments.push({ year, cost });
                });

                // Opcional: Pre-rellenar Foment 156
                const fomment156Year = 2025; const fomment156Cost = 7500;
                let fomment156Exists = futureInvestments.some(inv => inv.year === fomment156Year && inv.cost === fomment156Cost);
                const firstRow = document.querySelector('#futureInvestmentsContainer .future-investment-row');
                if (!fomment156Exists && firstRow) {
                    const firstYearInput = firstRow.querySelector('.future-investment-year');
                    const firstCostInput = firstRow.querySelector('.future-investment-cost');
                    if (!firstYearInput.value && !firstCostInput.value) {
                        firstYearInput.value = fomment156Year; firstCostInput.value = fomment156Cost;
                        futureInvestments.push({ year: fomment156Year, cost: fomment156Cost });
                        // No mostrar notificación aquí, ya está en la UI
                    }
                }

                const today = new Date();
                const initialInvestment = parkings.reduce((sum, p) => (parseFloat(p.purchasePrice) || 0) > 0 && (!p.purchaseDate || new Date(p.purchaseDate) <= today) ? sum + parseFloat(p.purchasePrice) : sum, 0);
                document.getElementById('compoundInitialInvestment').textContent = formatCurrency(initialInvestment);

                const initialBalance = finances.reduce((bal, f) => bal + ((f.type === 'income' ? 1 : -1) * (parseFloat(f.amount) || 0)), 0);
                document.getElementById('compoundInitialBalance').textContent = formatCurrency(initialBalance);

                let baseAnnualNetProfit = 0;
                const simpleForecastData = calculateSimpleForecastData(); // Puede lanzar error
                if (simpleForecastData && simpleForecastData.length > 0) {
                    baseAnnualNetProfit = simpleForecastData[0].balance;
                } else if (initialInvestment > 0) {
                     const roiTTMText = document.getElementById('annualROI').textContent || '0%';
                     const roiTTMPercent = parseFloat(roiTTMText.replace('%','')) || 0;
                     if (roiTTMPercent === 0 && isFinite(roiTTMPercent)) { // Solo error si es realmente 0 y no N/A
                         showNotification('ROI TTM es cero. No se puede estimar beneficio base.', 'warning');
                         // Permitir continuar si se quiere, baseAnnualNetProfit será 0
                     } else if (!isFinite(roiTTMPercent)) {
                         throw new Error("ROI TTM no es un número válido (N/A?).");
                     }
                     baseAnnualNetProfit = initialInvestment * (roiTTMPercent / 100);
                     showNotification('Usando ROI TTM como base para beneficio anual. Revisa la pestaña Previsiones.', 'warning');
                } else {
                     throw new Error("No hay inversión inicial ni previsión simple para estimar beneficio base.");
                }
                document.getElementById('compoundBaseAnnualProfit').textContent = formatCurrency(baseAnnualNetProfit);

                let cumulativeGain = initialBalance;
                let currentInvestedCapital = initialInvestment;
                let currentAnnualProfitEstimate = baseAnnualNetProfit;
                const results = [];
                const startYear = new Date().getFullYear();

                for (let i = 0; i < 5; i++) {
                    const currentYear = startYear + i;
                    const profitThisYear = currentAnnualProfitEstimate;
                    let investmentCostThisYear = futureInvestments.filter(inv => inv.year === currentYear).reduce((sum, inv) => sum + inv.cost, 0);

                    currentInvestedCapital += investmentCostThisYear;
                    cumulativeGain += profitThisYear - investmentCostThisYear;

                    results.push({
                        year: currentYear, investedCapitalEndOfYear: currentInvestedCapital,
                        profitGeneratedThisYear: profitThisYear, investmentMadeThisYear: investmentCostThisYear,
                        cumulativeNetGainEndOfYear: cumulativeGain
                    });
                    currentAnnualProfitEstimate = profitThisYear * (1 + profitGrowthRate);
                }
                renderCompoundForecastTable(results);

             } catch (error) {
                 console.error("Error al calcular proyección compuesta:", error);
                 showNotification(`Error en Proy. Compuesta: ${error.message}`, 'danger');
                 document.getElementById('compoundForecastTable').innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Error al calcular. ${error.message}</td></tr>`;
             }
        }

        function calculateSimpleForecastData() {
            const incrementRateInput = document.getElementById('forecastIncrementRate');
            const expenseRateInput = document.getElementById('forecastExpenseRate');
            const occupancyRateInput = document.getElementById('forecastOccupancyRate');
            if (!incrementRateInput || !expenseRateInput || !occupancyRateInput) throw new Error("Faltan elementos de input.");

            const incrementRate = (parseFloat(incrementRateInput.value) || 0) / 100;
            const expenseRate = (parseFloat(expenseRateInput.value) || 0) / 100;
            const occupancyRate = (parseFloat(occupancyRateInput.value) || 0) / 100;
            if (isNaN(incrementRate) || isNaN(expenseRate) || isNaN(occupancyRate) || occupancyRate <= 0) throw new Error("Parámetros inválidos o tasa ocupación cero.");
            if (parkings.length === 0) throw new Error("No hay parkings para calcular.");

            let potentialAnnualIncome = parkings.reduce((sum, p) => sum + (parseFloat(p.price) || 0) * 12, 0);
            let currentAnnualIncome = potentialAnnualIncome * occupancyRate;

            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1); oneYearAgo.setHours(0,0,0,0);
            const expenseTx = finances.filter(f => f.type === 'expense' && f.date);
            const firstExpDate = expenseTx.length > 0 ? new Date(Math.min.apply(null, expenseTx.map(f => new Date(f.date)))) : null;
            const startAvgDate = firstExpDate && firstExpDate > oneYearAgo ? firstExpDate : oneYearAgo;
            const relevantExp = expenseTx.filter(f => f.date && new Date(f.date) >= startAvgDate);
            let totalRelevantExp = relevantExp.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
            let currentAnnualExpenses = 0;
            if (relevantExp.length > 0) {
                const months = Math.max(1, (new Date() - startAvgDate) / (1000 * 60 * 60 * 24 * (365.25 / 12))); // Evitar división por cero
                currentAnnualExpenses = (totalRelevantExp / months) * 12;
            }
            if (currentAnnualExpenses === 0 && currentAnnualIncome > 0) currentAnnualExpenses = currentAnnualIncome * 0.3; // Fallback

            const forecastData = [];
            const currentInvestmentSimple = parkings.reduce((sum, p) => (parseFloat(p.purchasePrice) || 0) > 0 && (!p.purchaseDate || new Date(p.purchaseDate) <= new Date()) ? sum + parseFloat(p.purchasePrice) : sum, 0);
            let predictedIncome = currentAnnualIncome, predictedExpenses = currentAnnualExpenses;
            const startYear = new Date().getFullYear();

            for (let year = 1; year <= 5; year++) {
                if (year > 1) { predictedIncome *= (1 + incrementRate); predictedExpenses *= (1 + expenseRate); }
                const balance = predictedIncome - predictedExpenses;
                let roi = (currentInvestmentSimple > 0) ? (balance / currentInvestmentSimple) * 100 : 0;
                forecastData.push({ year: startYear + year - 1, income: predictedIncome, expenses: predictedExpenses, balance: balance, roi: isFinite(roi) ? roi : 0 });
            }
            return forecastData;
        }

        function renderCompoundForecastTable(results) {
            const tableBody = document.getElementById('compoundForecastTable');
            tableBody.innerHTML = '';
            if (!results || results.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No se generaron resultados.</td></tr>`; return;
            }
            results.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4 border-b text-center">${data.year}</td>
                    <td class="py-3 px-4 border-b text-right">${formatCurrency(data.investedCapitalEndOfYear)}</td>
                    <td class="py-3 px-4 border-b text-right text-green-600 dark:text-green-400">${formatCurrency(data.profitGeneratedThisYear)}</td>
                    <td class="py-3 px-4 border-b text-right text-red-600 dark:text-red-400">${formatCurrency(data.investmentMadeThisYear)}</td>
                    <td class="py-3 px-4 border-b text-right font-bold ${data.cumulativeNetGainEndOfYear >= 0 ? 'text-blue-700 dark:text-blue-300' : 'text-red-700 dark:text-red-300'}">${formatCurrency(data.cumulativeNetGainEndOfYear)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ===== FUNCIONES UTILITARIAS =====

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            let alertClass = 'alert-info';
            if (type === 'success') alertClass = 'alert-success';
            if (type === 'danger') alertClass = 'alert-danger';
            if (type === 'warning') alertClass = 'alert-warning';
            notification.className = `alert ${alertClass} shadow-lg fade-in flex items-center`;
            const iconClass = type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            notification.innerHTML = `
                <i class="fas ${iconClass} mr-3 text-xl flex-shrink-0"></i>
                <span class="flex-1 text-sm">${message}</span>
                <button class="ml-3 text-gray-500 hover:text-gray-800 flex-shrink-0" onclick="this.parentElement.remove()" aria-label="Cerrar notificación">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(notification);
            if (duration > 0) {
                 setTimeout(() => {
                    notification.style.transition = 'opacity 0.5s ease';
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 500);
                 }, duration);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const dateParts = dateString.split('-'); // Asume YYYY-MM-DD
                if (dateParts.length === 3) {
                    const date = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
                    if (!isNaN(date)) return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
                }
                const date = new Date(dateString); // Fallback para otros formatos
                if (!isNaN(date)) return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                return dateString;
            } catch (e) { return dateString; }
        }

        function formatCurrency(amount) {
             const num = parseFloat(amount);
             if (isNaN(num)) return '0,00 €';
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        }

    </script>
</body>
</html>
